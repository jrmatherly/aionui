appId: com.aionui.app
productName: AionUi
executableName: AionUi
copyright: Copyright © 2024 AionUi

asar:
  smartUnpack: true

directories:
  output: out
  buildResources: resources

files:
  - .webpack/main/**/*
  - .webpack/renderer/**/*
  - public/**/*
  - rules/**/*
  - skills/**/*
  - assistant/**/*
  - package.json
  - node_modules/better-sqlite3/**/*
  - node_modules/node-pty/**/*
  - node_modules/@mapbox/**/*
  - node_modules/detect-libc/**/*
  - node_modules/prebuild-install/**/*
  - node_modules/node-gyp-build/**/*
  - node_modules/bindings/**/*
  # tree-sitter WASM dependencies
  - node_modules/web-tree-sitter/**/*
  - node_modules/tree-sitter-bash/**/*
  # Pino logging (externalized from webpack — loaded via require() at runtime)
  # Pino uses thread-stream worker threads for transports; workers need real node_modules
  - node_modules/pino/**/*
  - node_modules/pino-pretty/**/*
  - node_modules/pino-roll/**/*
  - node_modules/pino-syslog/**/*
  - node_modules/pino-abstract-transport/**/*
  - node_modules/pino-std-serializers/**/*
  - node_modules/thread-stream/**/*
  - node_modules/real-require/**/*
  - node_modules/sonic-boom/**/*
  - node_modules/on-exit-leak-free/**/*
  - node_modules/@pinojs/**/*
  - node_modules/safe-stable-stringify/**/*
  - node_modules/atomic-sleep/**/*
  - node_modules/process-warning/**/*
  - node_modules/quick-format-unescaped/**/*
  # pino-pretty dependencies
  - node_modules/colorette/**/*
  - node_modules/dateformat/**/*
  - node_modules/fast-copy/**/*
  - node_modules/fast-safe-stringify/**/*
  - node_modules/help-me/**/*
  - node_modules/joycon/**/*
  - node_modules/minimist/**/*
  - node_modules/pump/**/*
  - node_modules/secure-json-parse/**/*
  - node_modules/strip-json-comments/**/*
  # pino-syslog dependencies
  - node_modules/fast-json-parse/**/*
  - node_modules/luxon/**/*
  - node_modules/nopt/**/*
  - node_modules/split2/**/*
  - node_modules/through2/**/*
  # pino-roll dependencies
  - node_modules/date-fns/**/*
  # Transitive dependencies (through2→readable-stream, pump→end-of-stream/once, nopt→abbrev)
  - node_modules/readable-stream/**/*
  - node_modules/end-of-stream/**/*
  - node_modules/once/**/*
  - node_modules/abbrev/**/*
  - node_modules/wrappy/**/*
  - node_modules/inherits/**/*
  - node_modules/string_decoder/**/*
  - node_modules/safe-buffer/**/*
  - node_modules/util-deprecate/**/*
  # CRITICAL: Exclude ALL tree-sitter native binaries to prevent signing issues
  - '!**/node_modules/tree-sitter-*/prebuilds/**'
  - '!**/node_modules/tree-sitter-*/build/**'
  - '!**/node_modules/tree-sitter-*/src/**'
  - '!**/node_modules/tree-sitter-*/**/*.node'
  - '!**/node_modules/tree-sitter-*/**/*.obj'
  - '!**/node_modules/tree-sitter-*/**/*.o'
  - '!**/node_modules/tree-sitter-*/**/*.cc'
  - '!**/node_modules/tree-sitter-*/**/*.c'
  # Exclude dev/test files
  - '!**/node_modules/*/{CHANGELOG.md,README.md,README,readme.md,readme}'
  - '!**/node_modules/*/{test,__tests__,tests,powered-test,example,examples}'
  - '!**/node_modules/*/{*.test.js,*.spec.js,*.test.ts,*.spec.ts}'
  - '!**/node_modules/*.d.ts'
  - '!**/node_modules/.bin'
  - '!**/node_modules/*/{docs,documentation,doc}'
  # Exclude system files
  - '!**/{.DS_Store,.git,.gitignore,.gitattributes}'
  - '!**/{__pycache__,thumbs.db,.flowconfig,.idea,.vs,.nyc_output}'
  - '!**/{appveyor.yml,.travis.yml,circle.yml}'
  - '!**/{npm-debug.log,yarn.lock,.yarn-metadata.json,yarn-error.log}'
  # Exclude large packages
  - '!**/node_modules/{@img,@emnapi}/**'
  - '!**/node_modules/@img/sharp-*/**'
  - '!**/node_modules/@anthropic-ai/claude-code/vendor/**'
  - '!**/node_modules/@anthropic-ai/claude-agent-sdk/vendor/**'
  # Exclude JAR files and JNI libraries that cause notarization issues
  - '!**/*.jar'
  - '!**/*.jnilib'
  # Exclude all vendor directories to prevent unsigned binaries
  - '!**/node_modules/*/vendor/**'
  - '!**/node_modules/@*/*/vendor/**'
  # Re-include vendor dirs for native modules that need them (if any)
  - 'node_modules/better-sqlite3/vendor/**'
  - 'node_modules/node-pty/vendor/**'
  # Exclude webpack source maps
  - '!**/*.map'
  - '!**/webpack-stats.json'
  # Exclude syntax highlighter languages (keep common ones)
  - '!**/.webpack/**/react-syntax-highlighter_languages_highlight_*'
  - '.webpack/**/react-syntax-highlighter_languages_highlight_{javascript,typescript,python,java,cpp,c,html,css,json,xml,yaml,shell,bash,dockerfile,sql,markdown,go,rust,php}'

extraResources:
  - from: public
    to: .
  # Favicon for web server
  - from: resources/app.ico
    to: app.ico

win:
  target:
    - nsis
    #    - msi
    - zip
  # icon: resources/app.ico  # Temporarily disabled - current ico is 32x32, need 256x256+
  artifactName: ${productName}-${version}-${os}-${arch}.${ext}

nsis:
  oneClick: false
  allowToChangeInstallationDirectory: true
  createDesktopShortcut: true
  createStartMenuShortcut: true
  shortcutName: ${productName}
  uninstallDisplayName: ${productName}
  artifactName: ${productName}-${version}-${os}-${arch}.${ext}

mac:
  target:
    - dmg
    - zip
  icon: resources/app.icns
  artifactName: ${productName}-${version}-${os}-${arch}.${ext}
  category: public.app-category.productivity
  hardenedRuntime: true
  gatekeeperAssess: false
  entitlements: entitlements.plist
  entitlementsInherit: entitlements.plist

dmg:
  # Use UDZO format which is more reliable on CI
  format: UDZO
  # Disable internet-enabled DMG to avoid network issues
  internetEnabled: false
  # Simple window settings to avoid layout issues
  window:
    width: 540
    height: 380
  # Contents positioning
  contents:
    - x: 140
      y: 180
      type: file
    - x: 400
      y: 180
      type: link
      path: /Applications

afterPack: scripts/afterPack.js
afterSign: scripts/afterSign.js

linux:
  target:
    - target: deb
      arch: [x64, arm64] # armv7l
    - target: AppImage
      arch: [x64, arm64]
  icon: resources/app.png
  artifactName: ${productName}-${version}-${os}-${arch}.${ext}
  category: Utility
  maintainer: aionui
  vendor: aionui
  synopsis: ${description}
  description: ${description}
  desktop:
    entry:
      Name: AionUi
      Comment: ${description}
      Icon: aionui
      Categories: Office;Utility;

npmRebuild: false
buildDependenciesFromSource: false
nodeGypRebuild: false

asarUnpack:
  - '**/node_modules/better-sqlite3/**/*'
  - '**/node_modules/node-pty/**/*'
  - '**/node_modules/@mapbox/**/*'
  - '**/node_modules/detect-libc/**/*'
  - '**/node_modules/prebuild-install/**/*'
  - '**/node_modules/node-gyp-build/**/*'
  - '**/node_modules/bindings/**/*'
  # tree-sitter WASM files need to be unpacked for fs.readFile access
  - '**/node_modules/web-tree-sitter/**/*'
  - '**/node_modules/tree-sitter-bash/**/*'
  # Builtin resources need to be unpacked for fs.readdir with withFileTypes
  # Required for Homebrew installations where asar paths may have issues
  - 'rules/**/*'
  - 'skills/**/*'
  - 'assistant/**/*'

compression: maximum
removePackageScripts: true
electronDownload:
  cache: ${env.ELECTRON_CACHE}

publish:
  provider: github
  owner: ${env.GITHUB_REPOSITORY_OWNER:-jrmatherly}
  repo: ${env.GITHUB_REPOSITORY_NAME:-aionui}
  publishAutoUpdate: false
