openapi: 3.0.3
info:
  title: AionUI WebUI API
  version: 1.8.2
  description: |
    REST API for AionUI WebUI server providing authentication, conversation management,
    and AI agent interaction capabilities.

    ## Authentication
    AionUI supports two authentication methods:
    - **Local**: Username/password authentication with JWT tokens
    - **OIDC/SSO**: Enterprise single sign-on via EntraID (Azure AD) or other OIDC providers

    All protected endpoints require JWT authentication via:
    - Cookie: `aion_session` (access token, 15 min expiry)
    - Header: `Authorization: Bearer <token>`
    
    Refresh tokens (7 day expiry) are issued via httpOnly `aionui-refresh` cookie.
    Use `/api/auth/refresh` to rotate tokens without re-authentication.

    ## Authorization (RBAC)
    Users have one of three roles:
    - **admin**: Full system access including user management
    - **user**: Standard access to conversations and AI features
    - **viewer**: Read-only access

    ## User Scoping
    All `/api/*` routes support user data isolation:
    - `req.scopedUserId` determines whose data to access
    - Admins can override via `?userId=` query parameter
    - Regular users can only access their own data

    ## Rate Limiting
    - Login endpoints: 5 requests per minute
    - API endpoints: 100 requests per minute
    - File operations: 30 requests per minute
    - Authenticated actions: 30 requests per minute

  contact:
    name: Jason Matherly
    email: jason@matherly.net
  license:
    name: Apache-2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:25808
    description: Local development server
  - url: https://{host}:{port}
    description: Production server
    variables:
      host:
        default: localhost
      port:
        default: "25808"

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Admin
    description: Administrative user and system management (requires admin role)
  - name: Directory
    description: File system directory operations (user-scoped)
  - name: Branding
    description: Application branding configuration
  - name: WebSocket
    description: Real-time communication endpoints

paths:
  # ===== Authentication =====
  /login:
    post:
      tags: [Authentication]
      summary: User login
      description: Authenticate user with username and password
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Session cookies (aion_session, aionui-refresh)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalError"

  /logout:
    post:
      tags: [Authentication]
      summary: User logout
      description: Invalidate current session and clear cookies
      operationId: logout
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Logged out successfully"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/auth/status:
    get:
      tags: [Authentication]
      summary: Get authentication status
      description: Check if system needs initial setup and OIDC availability
      operationId: getAuthStatus
      responses:
        "200":
          description: Authentication status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthStatusResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/user:
    get:
      tags: [Authentication]
      summary: Get current user
      description: Retrieve current authenticated user information
      operationId: getCurrentUser
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        "200":
          description: User information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/auth/change-password:
    post:
      tags: [Authentication]
      summary: Change password
      description: Change the current user's password (local auth only)
      operationId: changePassword
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Password changed successfully"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh access token
      description: |
        Rotate refresh token and issue new access + refresh tokens.
        Uses httpOnly `aionui-refresh` cookie for authentication.
      operationId: refreshToken
      responses:
        "200":
          description: Tokens refreshed successfully
          headers:
            Set-Cookie:
              schema:
                type: string
              description: New httpOnly aionui-refresh cookie
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshTokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/auth/oidc/login:
    get:
      tags: [Authentication]
      summary: Initiate OIDC login
      description: |
        Redirects to the configured OIDC identity provider (EntraID/Azure AD)
        for authentication. Available when OIDC is enabled.
      operationId: oidcLogin
      responses:
        "302":
          description: Redirect to identity provider
          headers:
            Location:
              schema:
                type: string
              description: OIDC authorization endpoint URL
        "503":
          description: OIDC not configured

  /api/auth/oidc/callback:
    get:
      tags: [Authentication]
      summary: OIDC callback handler
      description: |
        Handles the callback from OIDC provider. Exchanges authorization code
        for tokens, performs JIT (just-in-time) user provisioning if needed,
        and establishes session.
      operationId: oidcCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from OIDC provider
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
        - name: session_state
          in: query
          schema:
            type: string
          description: Optional session state from provider
      responses:
        "302":
          description: Redirect to application with session established
          headers:
            Location:
              schema:
                type: string
              description: Application URL (typically /)
            Set-Cookie:
              schema:
                type: string
              description: Session cookies (aion_session, aionui-refresh)
        "401":
          description: Authentication failed
          content:
            text/html:
              schema:
                type: string

  /api/auth/qr-login:
    post:
      tags: [Authentication]
      summary: QR code login
      description: Authenticate using QR code token (for mobile/desktop pairing)
      operationId: qrLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [qrToken]
              properties:
                qrToken:
                  type: string
                  description: QR token from scanned code
      responses:
        "200":
          description: QR login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /qr-login:
    get:
      tags: [Authentication]
      summary: QR login page
      description: Static HTML page for QR code login flow
      operationId: qrLoginPage
      responses:
        "200":
          description: QR login HTML page
          content:
            text/html:
              schema:
                type: string

  # ===== Branding =====
  /api/branding:
    get:
      tags: [Branding]
      summary: Get branding configuration
      description: |
        Public endpoint (no auth required). Returns branding configuration
        from environment variables. Used by login page and pre-auth UI.
      operationId: getBranding
      responses:
        "200":
          description: Branding configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BrandingConfig"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===== WebSocket =====
  /api/ws-token:
    get:
      tags: [WebSocket]
      summary: Get WebSocket token
      description: Get token for WebSocket connection (reuses main session token)
      operationId: getWsToken
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        "200":
          description: WebSocket token
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  wsToken:
                    type: string
                  expiresIn:
                    type: integer
                    description: Token expiry in milliseconds
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ===== Admin =====
  /api/admin/users:
    get:
      tags: [Admin]
      summary: List all users
      description: |
        Retrieve list of all users in the system. Password fields are sanitized.
        Requires admin role.
      operationId: listUsers
      security:
        - adminAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/AdminUserResponse"
                  total:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/admin/users/{id}:
    get:
      tags: [Admin]
      summary: Get user details
      description: Retrieve detailed information for a specific user. Requires admin role.
      operationId: getUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: User ID
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: "#/components/schemas/AdminUserResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: User not found

    delete:
      tags: [Admin]
      summary: Deactivate user
      description: |
        Soft deactivate user by setting role to viewer. User cannot be deleted
        if they are the last admin. Requires admin role.
      operationId: deactivateUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: User ID
      responses:
        "200":
          description: User deactivated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: User not found

  /api/admin/users/{id}/role:
    patch:
      tags: [Admin]
      summary: Update user role
      description: |
        Change a user's role. Includes self-demotion guard to prevent admins
        from demoting themselves. Requires admin role.
      operationId: updateUserRole
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: User ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleUpdateRequest"
      responses:
        "200":
          description: Role updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: User not found

  /api/admin/group-mappings:
    get:
      tags: [Admin]
      summary: Get OIDC group mappings
      description: |
        View configured OIDC group to role mappings. Shows how groups from
        the identity provider map to AionUI roles. Requires admin role.
      operationId: getGroupMappings
      security:
        - adminAuth: []
      responses:
        "200":
          description: Group mappings
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  mappings:
                    type: array
                    items:
                      $ref: "#/components/schemas/GroupMapping"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # ===== Directory =====
  /api/directory/browse:
    get:
      tags: [Directory]
      summary: Browse directory contents
      description: |
        List files and directories at specified path. Results are scoped
        to the user's workspace directory for security.
      operationId: browseDirectory
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Directory path to browse (relative to user workspace)
      responses:
        "200":
          description: Directory listing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DirectoryListing"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Directory not found

  /api/directory/validate:
    post:
      tags: [Directory]
      summary: Validate path
      description: Check if a path exists and is accessible within user's workspace
      operationId: validatePath
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [path]
              properties:
                path:
                  type: string
                  description: Path to validate
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  exists:
                    type: boolean
                  isDirectory:
                    type: boolean
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/directory/shortcuts:
    get:
      tags: [Directory]
      summary: Get directory shortcuts
      description: Get common directory shortcuts (workspace, cache, etc.)
      operationId: getShortcuts
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        "200":
          description: Directory shortcuts
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspace:
                    type: string
                  cache:
                    type: string
                  home:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/directory/upload:
    post:
      tags: [Directory]
      summary: Upload file
      description: |
        Upload a file to the user's workspace. Files are sent as base64-encoded
        JSON (max 75MB request body, ~50MB file after encoding).
      operationId: uploadFile
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename, content, targetPath]
              properties:
                filename:
                  type: string
                  description: Name of the file to create
                content:
                  type: string
                  format: byte
                  description: Base64-encoded file content
                targetPath:
                  type: string
                  description: Target directory path within workspace
      responses:
        "200":
          description: Upload successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  path:
                    type: string
                    description: Full path to uploaded file
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "413":
          description: Request entity too large (>75MB)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token (15 min expiry)
    cookieAuth:
      type: apiKey
      in: cookie
      name: aion_session
      description: Session cookie containing JWT access token
    adminAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token with admin role required

  schemas:
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          minLength: 1
          example: admin
        password:
          type: string
          minLength: 8
          format: password

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        user:
          $ref: "#/components/schemas/User"
        token:
          type: string
          description: JWT access token

    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        role:
          type: string
          enum: [admin, user, viewer]
          description: User's role determining access level
        authMethod:
          type: string
          enum: [local, oidc]
          description: Authentication method used
        displayName:
          type: string
          nullable: true
          description: User's display name (from OIDC or profile)
        email:
          type: string
          format: email
          nullable: true
          description: User's email address

    AuthStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        needsSetup:
          type: boolean
          description: True if no users exist
        userCount:
          type: integer
        isAuthenticated:
          type: boolean
        oidcEnabled:
          type: boolean
          description: True if OIDC/SSO authentication is configured

    UserResponse:
      type: object
      properties:
        success:
          type: boolean
        user:
          $ref: "#/components/schemas/User"

    AdminUserResponse:
      type: object
      description: User object with administrative fields (password sanitized)
      properties:
        id:
          type: string
        username:
          type: string
        role:
          type: string
          enum: [admin, user, viewer]
        authMethod:
          type: string
          enum: [local, oidc]
        displayName:
          type: string
          nullable: true
        email:
          type: string
          format: email
          nullable: true
        groups:
          type: array
          items:
            type: string
          description: OIDC groups (if applicable)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true
        lastLogin:
          type: string
          format: date-time
          nullable: true

    RoleUpdateRequest:
      type: object
      required: [role]
      properties:
        role:
          type: string
          enum: [admin, user, viewer]
          description: New role to assign to user

    GroupMapping:
      type: object
      description: OIDC group to role mapping configuration
      properties:
        group:
          type: string
          description: OIDC group name or ID from identity provider
        role:
          type: string
          enum: [admin, user, viewer]
          description: AionUI role to assign to members of this group
        priority:
          type: integer
          description: Mapping priority (higher numbers take precedence)

    RefreshTokenResponse:
      type: object
      properties:
        success:
          type: boolean
        token:
          type: string
          description: New access token (also set in aion_session cookie)
        expiresIn:
          type: integer
          description: Access token expiry in seconds (900 = 15 min)

    ChangePasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword:
          type: string
          format: password
        newPassword:
          type: string
          format: password
          minLength: 8
          description: Must meet security requirements

    BrandingConfig:
      type: object
      description: Application branding configuration from environment variables
      properties:
        appName:
          type: string
          default: AionUi
          description: Application display name
        logoUrl:
          type: string
          nullable: true
          description: URL to custom logo image
        faviconUrl:
          type: string
          nullable: true
          description: URL to custom favicon

    DirectoryListing:
      type: object
      properties:
        success:
          type: boolean
        path:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
                enum: [file, directory]
              size:
                type: integer
              modified:
                type: string
                format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        message:
          type: string
        code:
          type: string

  responses:
    Unauthorized:
      description: Authentication required or invalid
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            message: "Invalid username or password"

    Forbidden:
      description: Insufficient permissions (requires admin role)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            message: "Admin access required"

    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error: "Too many requests, please try again later"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            message: "Internal server error"
