# AionUi ä¸ªäººåŠ©æ‰‹åŠŸèƒ½å¼€å‘æ–¹æ¡ˆ

> æœ¬æ–‡æ¡£è®°å½•ä¸ªäººåŠ©æ‰‹åŠŸèƒ½çš„å®Œæ•´å¼€å‘æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æ’ä»¶ç³»ç»Ÿã€äº¤äº’è®¾è®¡ç­‰ã€‚

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŸºæœ¬ä¿¡æ¯

- **åŠŸèƒ½åç§°**: ä¸ªäººåŠ©æ‰‹åŠŸèƒ½
- **æ‰€å±æ¨¡å—**: Agent å±‚ã€å¯¹è¯ç³»ç»Ÿ
- **æ¶‰åŠè¿›ç¨‹**: ä¸»è¿›ç¨‹ (process)ã€Worker
- **è¿è¡Œç¯å¢ƒ**: GUI æ¨¡å¼ï¼ˆAionUi è¿è¡Œä¸­ï¼‰

### 1.2 åŠŸèƒ½æè¿°

1. ä¸ WebUI åŠŸèƒ½ç±»ä¼¼ï¼Œç”¨æˆ·å¯é€šè¿‡ä¸ªäººç»ˆç«¯ç›´æ¥ä½¿ç”¨ Aion åŠŸèƒ½
2. ä¸»è¦æ¶‰åŠä¸ªäººç”¨æˆ·çš„ IM é€šä¿¡å·¥å…·ï¼ˆTelegramã€Lark/Feishu ç­‰ï¼‰
3. æ‰“é€  7Ã—24 å°æ—¶ä¸ªäººç»ˆç«¯åŠ©æ‰‹
4. **å·²å®ç°å¹³å°**: Telegramï¼ˆgrammYï¼‰ã€Lark/Feishuï¼ˆå®˜æ–¹ SDKï¼‰
5. **æ”¯æŒçš„ Agent**: Geminiã€ACPã€Codex

### 1.3 ç”¨æˆ·åœºæ™¯

```
è§¦å‘: ç”¨æˆ·é€šè¿‡æ‰‹æœº IM å·¥å…·ï¼ˆå¦‚ Telegramï¼‰å‘é€æ¶ˆæ¯
è¿‡ç¨‹: å¹³å°æœºå™¨äººæ¥æ”¶æ¶ˆæ¯ â†’ è½¬å‘ç»™ Aion Agent â†’ LLM å¤„ç†
ç»“æœ: å¤„ç†å®Œæˆåé€šè¿‡ç›¸åŒå¹³å°æ¨é€ç»“æœç»™ç”¨æˆ·
```

### 1.4 å‚è€ƒé¡¹ç›®

- **Clawdbot**: https://github.com/clawdbot/clawdbot
- é‡‡çº³å…¶æ’ä»¶åŒ–è®¾è®¡ã€é…å¯¹å®‰å…¨æ¨¡å¼ã€Channel æŠ½è±¡ç­‰è®¾è®¡ç†å¿µ

---

## 2. æ•´ä½“æ¶æ„

### 2.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ChannelManager (å•ä¾‹)                        â”‚
â”‚                  (ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç»„ä»¶)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚PluginManagerâ”‚ â”‚SessionManagerâ”‚ â”‚PairingServiceâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ActionExecutorâ”‚ â”‚ChannelMessageService         â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 1: Plugin                          â”‚
â”‚                     (å¹³å°é€‚é…å±‚)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ Telegram â”‚ â”‚  Lark    â”‚  ... (Slack, Discord å¾…å®ç°)      â”‚
â”‚  â”‚  Plugin  â”‚ â”‚  Plugin  â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                    â”‚                                         â”‚
â”‚  èŒè´£: æ¥æ”¶å¹³å°æ¶ˆæ¯/å›è°ƒ â†’ è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ â†’ å‘é€å“åº”        â”‚
â”‚  ä¸å…³å¿ƒ: Agent ç±»å‹ã€ä¸šåŠ¡é€»è¾‘                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 2: Gateway                         â”‚
â”‚                     (ä¸šåŠ¡é€»è¾‘å±‚)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ActionExecutor: ç³»ç»Ÿ Action å¤„ç†ã€å¯¹è¯è·¯ç”±                  â”‚
â”‚  SessionManager: ä¼šè¯ç®¡ç†ã€ç”¨æˆ·æˆæƒ                          â”‚
â”‚  PairingService: é…å¯¹ç ç”Ÿæˆå’ŒéªŒè¯                            â”‚
â”‚  ChannelMessageService: æ¶ˆæ¯æµå¼å¤„ç†                        â”‚
â”‚                                                              â”‚
â”‚  èŒè´£: ç³»ç»Ÿ Action å¤„ç†ã€å¯¹è¯è·¯ç”±ã€ä¼šè¯ç®¡ç†ã€æƒé™æ§åˆ¶       â”‚
â”‚  ä¸å…³å¿ƒ: å¹³å°ç»†èŠ‚ã€Agent å®ç°ç»†èŠ‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 3: Agent                           â”‚
â”‚                     (AI å¤„ç†å±‚)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Gemini  â”‚  â”‚   ACP   â”‚  â”‚  Codex  â”‚                      â”‚
â”‚  â”‚  Agent  â”‚  â”‚  Agent  â”‚  â”‚  Agent  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                              â”‚
â”‚  èŒè´£: ä¸ AI æœåŠ¡é€šä¿¡ã€ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ã€è¿”å›ç»Ÿä¸€å“åº”         â”‚
â”‚  ä¸å…³å¿ƒ: æ¶ˆæ¯æ¥æºå¹³å°ã€ç³»ç»Ÿçº§æ“ä½œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

```
å…¥ç«™æµç¨‹:
  å¹³å°æ¶ˆæ¯ â†’ Plugin(è½¬æ¢) â†’ ActionExecutor(è·¯ç”±) â†’ Agent(å¤„ç†)

  è¯¦ç»†æµç¨‹:
  1. Plugin æ¥æ”¶å¹³å°æ¶ˆæ¯ â†’ toUnifiedIncomingMessage()
  2. PluginManager è°ƒç”¨ messageHandler â†’ ActionExecutor.handleMessage()
  3. ActionExecutor æ ¹æ® Action ç±»å‹è·¯ç”±:
     - Platform Action â†’ Plugin è‡ªè¡Œå¤„ç†
     - System Action â†’ SystemActions å¤„ç†
     - Chat Action â†’ ChannelMessageService â†’ Agent

å‡ºç«™æµç¨‹:
  Agent å“åº” â†’ ChannelEventBus â†’ ChannelMessageService â†’ ActionExecutor â†’ Plugin(è½¬æ¢) â†’ å¹³å°å‘é€

  è¯¦ç»†æµç¨‹:
  1. Agent Worker å‘é€æ¶ˆæ¯ â†’ ChannelEventBus.emitAgentMessage()
  2. ChannelMessageService ç›‘å¬äº‹ä»¶ â†’ handleAgentMessage()
  3. transformMessage + composeMessage â†’ StreamCallback
  4. ActionExecutor è°ƒç”¨ context.sendMessage/editMessage()
  5. Plugin è½¬æ¢æ¶ˆæ¯æ ¼å¼ â†’ sendMessage/editMessage()
```

---

## 3. æ’ä»¶ç³»ç»Ÿè®¾è®¡

### 3.1 æ’ä»¶èŒè´£è¾¹ç•Œ

| æ’ä»¶è´Ÿè´£                       | æ’ä»¶ä¸è´Ÿè´£         |
| ------------------------------ | ------------------ |
| è¿æ¥å¹³å° API                   | Agent è°ƒåº¦å’Œæ‰§è¡Œ   |
| æ¥æ”¶æ¶ˆæ¯ â†’ è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼      | ä¼šè¯ç®¡ç†å’ŒæŒä¹…åŒ–   |
| ç»Ÿä¸€æ ¼å¼ â†’ è½¬æ¢ä¸ºå¹³å°æ¶ˆæ¯      | ç”¨æˆ·è®¤è¯å’Œæƒé™æ§åˆ¶ |
| å¤„ç†å¹³å°ç‰¹æœ‰å‘½ä»¤               | æ¶ˆæ¯è·¯ç”±å†³ç­–       |
| æµå¼æ¶ˆæ¯æ›´æ–°ï¼ˆç¼–è¾‘å·²å‘é€æ¶ˆæ¯ï¼‰ |                    |

### 3.2 æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

```
created â†’ initializing â†’ ready â†’ starting â†’ running â†’ stopping â†’ stopped
                â†“                    â†“           â†“
              error â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†
```

| çŠ¶æ€           | è¯´æ˜                 |
| -------------- | -------------------- |
| `created`      | æ’ä»¶å®ä¾‹å·²åˆ›å»º       |
| `initializing` | æ­£åœ¨éªŒè¯é…ç½®å’Œåˆå§‹åŒ– |
| `ready`        | åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…å¯åŠ¨ |
| `starting`     | æ­£åœ¨è¿æ¥å¹³å°         |
| `running`      | æ­£å¸¸è¿è¡Œä¸­           |
| `stopping`     | æ­£åœ¨æ–­å¼€è¿æ¥         |
| `stopped`      | å·²åœæ­¢               |
| `error`        | å‘ç”Ÿé”™è¯¯             |

### 3.3 æ’ä»¶æ¥å£ï¼ˆBasePlugin æŠ½è±¡ç±»ï¼‰

| æ¥å£æ–¹æ³•               | æ–¹å‘                    | è¯´æ˜                       |
| ---------------------- | ----------------------- | -------------------------- |
| `initialize(config)`   | PluginManager â†’ Plugin  | åˆå§‹åŒ–æ’ä»¶é…ç½®             |
| `start()`              | PluginManager â†’ Plugin  | å¯åŠ¨å¹³å°è¿æ¥               |
| `stop()`               | PluginManager â†’ Plugin  | åœæ­¢å¹³å°è¿æ¥               |
| `sendMessage(...)`     | ActionExecutor â†’ Plugin | å‘é€æ¶ˆæ¯åˆ°å¹³å°             |
| `editMessage(...)`     | ActionExecutor â†’ Plugin | ç¼–è¾‘å·²å‘é€æ¶ˆæ¯ï¼ˆæµå¼æ›´æ–°ï¼‰ |
| `getStatus()`          | PluginManager â†’ Plugin  | è·å–æ’ä»¶çŠ¶æ€               |
| `getActiveUserCount()` | PluginManager â†’ Plugin  | è·å–æ´»è·ƒç”¨æˆ·æ•°             |
| `getBotInfo()`         | PluginManager â†’ Plugin  | è·å– Bot ä¿¡æ¯              |
| `onInitialize()`       | å­ç±»å®ç°                | å¹³å°ç‰¹å®šçš„åˆå§‹åŒ–é€»è¾‘       |
| `onStart()`            | å­ç±»å®ç°                | å¹³å°ç‰¹å®šçš„å¯åŠ¨é€»è¾‘         |
| `onStop()`             | å­ç±»å®ç°                | å¹³å°ç‰¹å®šçš„åœæ­¢é€»è¾‘         |

### 3.4 ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼

**å…¥ç«™æ¶ˆæ¯ï¼ˆå¹³å° â†’ ç³»ç»Ÿï¼‰** - `IUnifiedIncomingMessage`

| å­—æ®µ               | è¯´æ˜                                    |
| ------------------ | --------------------------------------- |
| `id`               | ç³»ç»Ÿç”Ÿæˆçš„å”¯ä¸€ ID                       |
| `platform`         | æ¥æºå¹³å°ï¼ˆtelegram/lark/slack/discordï¼‰ |
| `chatId`           | èŠå¤© ID                                 |
| `user`             | ç”¨æˆ·ä¿¡æ¯ï¼ˆidã€usernameã€displayNameï¼‰   |
| `content`          | æ¶ˆæ¯å†…å®¹ï¼ˆtypeã€textã€attachmentsï¼‰     |
| `timestamp`        | æ—¶é—´æˆ³                                  |
| `replyToMessageId` | å›å¤çš„æ¶ˆæ¯ IDï¼ˆå¯é€‰ï¼‰                   |
| `action`           | Action ä¿¡æ¯ï¼ˆæŒ‰é’®å›è°ƒæ—¶ï¼‰               |
| `raw`              | å¹³å°åŸå§‹æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰                    |

**å‡ºç«™æ¶ˆæ¯ï¼ˆç³»ç»Ÿ â†’ å¹³å°ï¼‰** - `IUnifiedOutgoingMessage`

| å­—æ®µ               | è¯´æ˜                                  |
| ------------------ | ------------------------------------- |
| `type`             | æ¶ˆæ¯ç±»å‹ï¼ˆtext/image/file/buttonsï¼‰   |
| `text`             | æ–‡æœ¬å†…å®¹                              |
| `parseMode`        | è§£ææ¨¡å¼ï¼ˆHTML/Markdown/MarkdownV2ï¼‰  |
| `buttons`          | Inline æŒ‰é’®ç»„ï¼ˆå¯é€‰ï¼‰                 |
| `keyboard`         | Reply Keyboardï¼ˆå¯é€‰ï¼‰                |
| `replyMarkup`      | å¹³å°ç‰¹å®š Markupï¼ˆå¯é€‰ï¼Œå¦‚ Lark Cardï¼‰ |
| `replyToMessageId` | å›å¤çš„æ¶ˆæ¯ IDï¼ˆå¯é€‰ï¼‰                 |
| `imageUrl`         | å›¾ç‰‡ URLï¼ˆimage ç±»å‹ï¼‰                |
| `fileUrl`          | æ–‡ä»¶ URLï¼ˆfile ç±»å‹ï¼‰                 |
| `fileName`         | æ–‡ä»¶åï¼ˆfile ç±»å‹ï¼‰                   |
| `silent`           | é™é»˜å‘é€ï¼ˆå¯é€‰ï¼‰                      |

### 3.5 æ‰©å±•æ–°å¹³å°æ­¥éª¤

1. åˆ›å»º `src/channels/plugins/[platform]/` ç›®å½•
2. å®ç° `[Platform]Plugin` ç»§æ‰¿ `BasePlugin`
3. å®ç° `[Platform]Adapter` å¤„ç†æ¶ˆæ¯è½¬æ¢ï¼ˆtoUnifiedIncomingMessage, to[Platform]SendParamsï¼‰
4. åœ¨ `ChannelManager` æ„é€ å‡½æ•°ä¸­æ³¨å†Œæ’ä»¶ï¼š`registerPlugin('platform', PlatformPlugin)`
5. åœ¨ `types.ts` ä¸­æ·»åŠ å¹³å°ç±»å‹åˆ° `PluginType`
6. æ·»åŠ è®¾ç½®é¡µé¢ UI
7. æ·»åŠ  i18n ç¿»è¯‘
8. å®ç°å¹³å°ç‰¹å®šçš„äº¤äº’ç»„ä»¶ï¼ˆå¦‚ Keyboardã€Card ç­‰ï¼‰

---

## 4. å·²å®ç°å¹³å°

### 4.1 Telegram æ¥å…¥

#### æŠ€æœ¯é€‰å‹

| é¡¹ç›®     | é€‰æ‹©              | è¯´æ˜                    |
| -------- | ----------------- | ----------------------- |
| Bot åº“   | grammY            | Clawdbot ä½¿ç”¨ï¼ŒAPI ä¼˜é›… |
| è¿è¡Œæ¨¡å¼ | Pollingï¼ˆé•¿è½®è¯¢ï¼‰ | è‡ªåŠ¨é‡è¿æœºåˆ¶            |

### 4.1 æŠ€æœ¯é€‰å‹

| é¡¹ç›®     | é€‰æ‹©                             | è¯´æ˜                    |
| -------- | -------------------------------- | ----------------------- |
| Bot åº“   | grammY                           | Clawdbot ä½¿ç”¨ï¼ŒAPI ä¼˜é›… |
| è¿è¡Œæ¨¡å¼ | Pollingï¼ˆå¼€å‘ï¼‰/ Webhookï¼ˆç”Ÿäº§ï¼‰ | å¯é…ç½®                  |

#### Bot é…ç½®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: åˆ›å»º Bot                                            â”‚
â”‚   ç”¨æˆ·åœ¨ Telegram ä¸­ @BotFather â†’ /newbot â†’ è·å– Token      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: é…ç½® Token                                          â”‚
â”‚   AionUi è®¾ç½®é¡µé¢ â†’ ç²˜è´´ Token â†’ éªŒè¯ â†’ ä¿å­˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: å¯åŠ¨ Bot                                            â”‚
â”‚   å¼€å¯å¼€å…³ â†’ Bot å¼€å§‹ç›‘å¬                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 4: ç”¨æˆ·é…å¯¹ï¼ˆè§ä¸‹æ–¹å®‰å…¨æœºåˆ¶ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…ç½®é¡¹

| é…ç½®é¡¹      | ç±»å‹              | è¯´æ˜                       |
| ----------- | ----------------- | -------------------------- |
| Bot Token   | string            | ä» @BotFather è·å–         |
| è¿è¡Œæ¨¡å¼    | polling / webhook | Polling é€‚åˆå¼€å‘           |
| Webhook URL | string            | ä»… webhook æ¨¡å¼éœ€è¦        |
| é…å¯¹æ¨¡å¼    | boolean           | æ˜¯å¦éœ€è¦é…å¯¹ç æˆæƒ         |
| é€Ÿç‡é™åˆ¶    | number            | æ¯åˆ†é’Ÿæœ€å¤§æ¶ˆæ¯æ•°           |
| ç¾¤ç»„ @æåŠ  | boolean           | ç¾¤ç»„ä¸­æ˜¯å¦éœ€è¦ @bot æ‰å“åº” |
| é»˜è®¤ Agent  | gemini            | MVP é˜¶æ®µå›ºå®š Gemini        |

#### é…å¯¹å®‰å…¨æœºåˆ¶ï¼ˆé‡‡ç”¨ Clawdbot æ¨¡å¼ï¼‰

**æ ¸å¿ƒåŸåˆ™**: æ‰¹å‡†æ“ä½œåœ¨ç”¨æˆ·æœ¬åœ°è®¾å¤‡å®Œæˆï¼Œè€Œéåœ¨ Telegram ä¸­å®Œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘  ç”¨æˆ·åœ¨ Telegram ä¸­å‘èµ·                                   â”‚
â”‚    ç”¨æˆ· â†’ @YourBot: /start æˆ–ä»»æ„æ¶ˆæ¯                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘¡ Bot è¿”å›é…å¯¹è¯·æ±‚                                         â”‚
â”‚    Bot â†’ ç”¨æˆ·:                                             â”‚
â”‚    "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Aion åŠ©æ‰‹ï¼                                â”‚
â”‚     æ‚¨çš„é…å¯¹ç : ABC123                                     â”‚
â”‚     è¯·åœ¨ AionUi ä¸­æ‰¹å‡†æ­¤é…å¯¹:                              â”‚
â”‚     è®¾ç½® â†’ Telegram â†’ å¾…æ‰¹å‡†è¯·æ±‚ â†’ [æ‰¹å‡†]"                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘¢ AionUi æ˜¾ç¤ºå¾…æ‰¹å‡†è¯·æ±‚                                    â”‚
â”‚    è®¾ç½®é¡µé¢å±•ç¤º: ç”¨æˆ·åã€é…å¯¹ç ã€è¯·æ±‚æ—¶é—´ã€[æ‰¹å‡†]/[æ‹’ç»]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘£ ç”¨æˆ·åœ¨ AionUi ç‚¹å‡» [æ‰¹å‡†]                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘¤ Bot é€šçŸ¥é…å¯¹æˆåŠŸ                                         â”‚
â”‚    Bot â†’ ç”¨æˆ·: "âœ… é…å¯¹æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®‰å…¨æªæ–½**

| æœºåˆ¶           | è¯´æ˜                                 |
| -------------- | ------------------------------------ |
| é…å¯¹ç è®¤è¯     | 6ä½éšæœºç ï¼Œ10åˆ†é’Ÿæœ‰æ•ˆ                |
| æœ¬åœ°æ‰¹å‡†       | å¿…é¡»åœ¨ AionUi ä¸­æ‰¹å‡†ï¼Œé Telegram ä¸­ |
| ç”¨æˆ·ç™½åå•     | ä»…æˆæƒç”¨æˆ·å¯ä½¿ç”¨                     |
| é€Ÿç‡é™åˆ¶       | é˜²æ­¢æ»¥ç”¨                             |
| Token åŠ å¯†å­˜å‚¨ | ä½¿ç”¨ bcrypt åŠ å¯†                     |

#### æ¶ˆæ¯è½¬æ¢è§„åˆ™

**å…¥ç«™è½¬æ¢ï¼ˆTelegram â†’ ç»Ÿä¸€æ ¼å¼ï¼‰**

| Telegram æ¶ˆæ¯ç±»å‹  | ç»Ÿä¸€æ¶ˆæ¯ content.type            |
| ------------------ | -------------------------------- |
| `message:text`     | `text` æˆ– `command`ï¼ˆä»¥ / å¼€å¤´ï¼‰ |
| `message:photo`    | `image`                          |
| `message:document` | `file`                           |
| `message:voice`    | `audio`                          |

**å‡ºç«™è½¬æ¢ï¼ˆç»Ÿä¸€æ ¼å¼ â†’ Telegramï¼‰**

| ç»Ÿä¸€æ¶ˆæ¯ type | Telegram API                      |
| ------------- | --------------------------------- |
| `text`        | `sendMessage`                     |
| `image`       | `sendPhoto`                       |
| `file`        | `sendDocument`                    |
| `buttons`     | `sendMessage` + `inline_keyboard` |

**ç‰¹æ®Šå¤„ç†**

| åœºæ™¯      | å¤„ç†æ–¹å¼                                     |
| --------- | -------------------------------------------- |
| æµå¼å“åº”  | ä½¿ç”¨ `editMessageText` æ›´æ–°æ¶ˆæ¯ï¼Œæ·»åŠ  â–Œ å…‰æ ‡ |
| Markdown  | è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨ `parse_mode: Markdown`    |
| @æåŠç§»é™¤ | æ¸…ç†æ¶ˆæ¯ä¸­çš„ `@bot_username`                 |
| ç¾¤ç»„è¿‡æ»¤  | æ£€æŸ¥æ˜¯å¦åŒ…å« @æåŠï¼ˆå¯é…ç½®ï¼‰                 |

### 4.2 Lark/Feishu æ¥å…¥

#### æŠ€æœ¯é€‰å‹

| é¡¹ç›®     | é€‰æ‹©                           | è¯´æ˜           |
| -------- | ------------------------------ | -------------- |
| SDK      | @larksuiteoapi/node-sdk        | å®˜æ–¹ SDK       |
| è¿è¡Œæ¨¡å¼ | WebSocket é•¿è¿æ¥               | æ— éœ€å…¬ç½‘ URL   |
| åŸŸ       | Feishuï¼ˆå¯é…ç½®ä¸º Lark å›½é™…ç‰ˆï¼‰ | é»˜è®¤ä½¿ç”¨é£ä¹¦åŸŸ |

#### Bot é…ç½®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: åˆ›å»ºåº”ç”¨                                            â”‚
â”‚   åœ¨é£ä¹¦å¼€æ”¾å¹³å°åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨ â†’ è·å– App ID å’Œ App Secret â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: é…ç½®æƒé™                                            â”‚
â”‚   åº”ç”¨æƒé™ç®¡ç† â†’ å¼€é€š"è·å–ä¸å‘é€å•èŠã€ç¾¤ç»„æ¶ˆæ¯"æƒé™          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: é…ç½®äº‹ä»¶è®¢é˜…                                        â”‚
â”‚   äº‹ä»¶è®¢é˜… â†’ è®¢é˜…"æ¥æ”¶æ¶ˆæ¯"äº‹ä»¶ â†’ é…ç½®åŠ å¯†å¯†é’¥ï¼ˆå¯é€‰ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 4: é…ç½®å‡­è¯                                            â”‚
â”‚   AionUi è®¾ç½®é¡µé¢ â†’ ç²˜è´´ App IDã€App Secret â†’ éªŒè¯ â†’ ä¿å­˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 5: å¯åŠ¨ Bot                                            â”‚
â”‚   å¼€å¯å¼€å…³ â†’ Bot é€šè¿‡ WebSocket è¿æ¥å¼€å§‹ç›‘å¬               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 6: ç”¨æˆ·é…å¯¹ï¼ˆè§ä¸‹æ–¹å®‰å…¨æœºåˆ¶ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…ç½®é¡¹

| é…ç½®é¡¹             | ç±»å‹    | è¯´æ˜                   |
| ------------------ | ------- | ---------------------- |
| App ID             | string  | ä»é£ä¹¦å¼€æ”¾å¹³å°è·å–     |
| App Secret         | string  | ä»é£ä¹¦å¼€æ”¾å¹³å°è·å–     |
| Encrypt Key        | string  | äº‹ä»¶åŠ å¯†å¯†é’¥ï¼ˆå¯é€‰ï¼‰   |
| Verification Token | string  | äº‹ä»¶éªŒè¯ Tokenï¼ˆå¯é€‰ï¼‰ |
| é…å¯¹æ¨¡å¼           | boolean | æ˜¯å¦éœ€è¦é…å¯¹ç æˆæƒ     |
| é€Ÿç‡é™åˆ¶           | number  | æ¯åˆ†é’Ÿæœ€å¤§æ¶ˆæ¯æ•°       |
| é»˜è®¤ Agent         | gemini  | MVP é˜¶æ®µå›ºå®š Gemini    |

#### é…å¯¹å®‰å…¨æœºåˆ¶

ä¸ Telegram ç›¸åŒï¼Œé‡‡ç”¨æœ¬åœ°æ‰¹å‡†æ¨¡å¼ã€‚é…å¯¹ç é€šè¿‡ Lark æ¶ˆæ¯å‘é€ç»™ç”¨æˆ·ï¼Œç”¨æˆ·åœ¨ AionUi ä¸­æ‰¹å‡†ã€‚

#### æ¶ˆæ¯è½¬æ¢è§„åˆ™

**å…¥ç«™è½¬æ¢ï¼ˆLark â†’ ç»Ÿä¸€æ ¼å¼ï¼‰**

| Lark æ¶ˆæ¯ç±»å‹   | ç»Ÿä¸€æ¶ˆæ¯ content.type              |
| --------------- | ---------------------------------- |
| `message:text`  | `text` æˆ– `command`ï¼ˆä»¥ / å¼€å¤´ï¼‰   |
| `message:image` | `photo`                            |
| `message:file`  | `document`                         |
| `message:audio` | `audio`                            |
| Card Action     | `action`ï¼ˆé€šè¿‡ extractCardActionï¼‰ |

**å‡ºç«™è½¬æ¢ï¼ˆç»Ÿä¸€æ ¼å¼ â†’ Larkï¼‰**

| ç»Ÿä¸€æ¶ˆæ¯ type    | Lark API                   |
| ---------------- | -------------------------- |
| `text`           | `im.message.create`        |
| `buttons`        | `im.message.create` + Card |
| Interactive Card | ä½¿ç”¨ Lark Card æ ¼å¼        |

**ç‰¹æ®Šå¤„ç†**

| åœºæ™¯             | å¤„ç†æ–¹å¼                                               |
| ---------------- | ------------------------------------------------------ |
| æµå¼å“åº”         | ä½¿ç”¨ `im.message.update` æ›´æ–°æ¶ˆæ¯                      |
| HTML è½¬ Markdown | convertHtmlToLarkMarkdown() è½¬æ¢ HTML ä¸º Lark Markdown |
| Card äº¤äº’        | ä½¿ç”¨ Lark Card æ ¼å¼ï¼Œæ”¯æŒæŒ‰é’®ã€ç¡®è®¤ç­‰                  |
| äº‹ä»¶å»é‡         | 5 åˆ†é’Ÿäº‹ä»¶ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤å¤„ç†                           |

---

## 5. äº¤äº’è®¾è®¡

### 5.1 è®¾è®¡åŸåˆ™

**æŒ‰é’®ä¼˜å…ˆï¼Œå‘½ä»¤ä¿ç•™**ï¼šæ™®é€šç”¨æˆ·é€šè¿‡æŒ‰é’®æ“ä½œï¼Œé«˜çº§ç”¨æˆ·å¯ä½¿ç”¨å‘½ä»¤

### 5.2 Telegram äº¤äº’ç»„ä»¶

| ç±»å‹                | è¯´æ˜           | é€‚ç”¨åœºæ™¯           |
| ------------------- | -------------- | ------------------ |
| **Inline Keyboard** | æ¶ˆæ¯ä¸‹æ–¹çš„æŒ‰é’® | æ“ä½œç¡®è®¤ã€é€‰é¡¹é€‰æ‹© |
| **Reply Keyboard**  | æ›¿æ¢è¾“å…¥æ³•é”®ç›˜ | å¸¸ç”¨æ“ä½œå¿«æ·å…¥å£   |
| **Menu Button**     | èŠå¤©è¾“å…¥æ¡†å·¦ä¾§ | å›ºå®šåŠŸèƒ½å…¥å£       |

### 5.3 äº¤äº’åœºæ™¯è®¾è®¡

**åœºæ™¯ 1: é¦–æ¬¡ä½¿ç”¨/é…å¯¹**

```
Bot æ¶ˆæ¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Aion åŠ©æ‰‹ï¼                 â”‚
â”‚                                          â”‚
â”‚ ğŸ”‘ é…å¯¹ç : ABC123                       â”‚
â”‚ è¯·åœ¨ AionUi è®¾ç½®ä¸­æ‰¹å‡†æ­¤é…å¯¹            â”‚
â”‚                                          â”‚
â”‚ [ğŸ“– ä½¿ç”¨æŒ‡å—]  [â“ è·å–å¸®åŠ©]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 2: é…å¯¹æˆåŠŸåï¼ˆReply Keyboard å¸¸é©»ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ... å¯¹è¯å†…å®¹ ...                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Reply Keyboard (å¸¸é©»å¿«æ·æ“ä½œ)           â”‚
â”‚ [ğŸ†• æ–°å¯¹è¯] [ğŸ“Š çŠ¶æ€] [â“ å¸®åŠ©]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è¾“å…¥æ¶ˆæ¯...]                   [å‘é€]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 3: AI å›å¤å¸¦æ“ä½œæŒ‰é’®**

````
Bot æ¶ˆæ¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿæ’åºçš„å®ç°ï¼š               â”‚
â”‚                                          â”‚
â”‚ ```python                                â”‚
â”‚ def quicksort(arr):                      â”‚
â”‚     ...                                  â”‚
â”‚ ```                                      â”‚
â”‚                                          â”‚
â”‚ [ğŸ“‹ å¤åˆ¶] [ğŸ”„ é‡æ–°ç”Ÿæˆ] [ğŸ’¬ ç»§ç»­]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
````

**åœºæ™¯ 4: è®¾ç½®é¡µé¢ï¼ˆå¡ç‰‡å¼é€‰æ‹©ï¼‰**

```
Bot æ¶ˆæ¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš™ï¸ è®¾ç½®                                 â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¤– AI æ¨¡å‹                          â”‚ â”‚
â”‚ â”‚ å½“å‰: Gemini 1.5 Pro                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’¬ å¯¹è¯é£æ ¼                         â”‚ â”‚
â”‚ â”‚ å½“å‰: ä¸“ä¸š                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚ [â† è¿”å›]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 æŒ‰é’®ä¸å‘½ä»¤å¯¹ç…§

| å‘½ä»¤ï¼ˆéšè—ä¿ç•™ï¼‰ | æŒ‰é’®ï¼ˆç”¨æˆ·å¯è§ï¼‰ |
| ---------------- | ---------------- |
| `/start`         | è‡ªåŠ¨è§¦å‘         |
| `/new`           | ğŸ†• æ–°å¯¹è¯        |
| `/status`        | ğŸ“Š çŠ¶æ€          |
| `/help`          | â“ å¸®åŠ©          |

---

## 6. Action ç»Ÿä¸€å¤„ç†æœºåˆ¶

### 6.1 è®¾è®¡ç›®æ ‡

å‘½ä»¤å’ŒæŒ‰é’®å›è°ƒé‡‡ç”¨ç»Ÿä¸€å¤„ç†ï¼Œé¿å…é‡å¤é€»è¾‘ï¼Œä¾¿äºå¤šå¹³å°æ‰©å±•

### 6.2 Action åˆ†ç±»

| ç±»å‹            | è¯´æ˜                         | å¤„ç†æ–¹                |
| --------------- | ---------------------------- | --------------------- |
| **å¹³å° Action** | å¹³å°ç‰¹æœ‰æ“ä½œï¼ˆè®¤è¯ã€é…å¯¹ç­‰ï¼‰ | Plugin å†…éƒ¨å¤„ç†       |
| **ç³»ç»Ÿ Action** | å¹³å°æ— å…³çš„ç³»ç»Ÿçº§æ“ä½œ         | Gateway ActionHandler |
| **å¯¹è¯ Action** | éœ€è¦ Agent å¤„ç†çš„æ¶ˆæ¯        | AgentRouter â†’ Agent   |

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â”œâ”€â†’ å¹³å° Action â†’ Plugin è‡ªè¡Œå¤„ç†ï¼ˆä¸è¿›å…¥ Gatewayï¼‰
    â”‚       ä¾‹: Telegram é…å¯¹ã€Slack OAuthã€Discord é‚€è¯·
    â”‚
    â”œâ”€â†’ ç³»ç»Ÿ Action â†’ Gateway ActionHandler â†’ ç»Ÿä¸€å¤„ç†
    â”‚       ä¾‹: ä¼šè¯ç®¡ç†ã€è®¾ç½®ã€å¸®åŠ©
    â”‚
    â””â”€â†’ å¯¹è¯ Action â†’ AgentRouter â†’ Gemini/ACP/Codex
```

### 6.3 ç³»ç»Ÿ Action åˆ—è¡¨ï¼ˆå¹³å°æ— å…³ï¼‰

| åˆ†ç±»         | Action                  | è¯´æ˜               |
| ------------ | ----------------------- | ------------------ |
| **ä¼šè¯ç®¡ç†** | `session.new`           | åˆ›å»ºæ–°ä¼šè¯         |
|              | `session.status`        | æŸ¥çœ‹å½“å‰çŠ¶æ€       |
|              | `session.list`          | ä¼šè¯åˆ—è¡¨ï¼ˆæ‰©å±•ï¼‰   |
|              | `session.switch`        | åˆ‡æ¢ä¼šè¯ï¼ˆæ‰©å±•ï¼‰   |
| **è®¾ç½®æ“ä½œ** | `settings.show`         | æ˜¾ç¤ºè®¾ç½®èœå•       |
|              | `settings.model.list`   | æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨       |
|              | `settings.model.select` | é€‰æ‹©æ¨¡å‹           |
|              | `settings.agent.select` | åˆ‡æ¢ Agentï¼ˆæ‰©å±•ï¼‰ |
| **å¸®åŠ©ä¿¡æ¯** | `help.show`             | æ˜¾ç¤ºå¸®åŠ©           |
| **å¯¼èˆª**     | `nav.back`              | è¿”å›ä¸Šä¸€çº§         |
|              | `nav.cancel`            | å–æ¶ˆå½“å‰æ“ä½œ       |

### 6.4 å¹³å° Action ç¤ºä¾‹ï¼ˆå„ Plugin è‡ªè¡Œå®ç°ï¼‰

| å¹³å°         | Action            | è¯´æ˜            |
| ------------ | ----------------- | --------------- |
| **Telegram** | `pairing.show`    | æ˜¾ç¤ºé…å¯¹ç       |
|              | `pairing.refresh` | åˆ·æ–°é…å¯¹ç       |
| **Slack**    | `oauth.start`     | å‘èµ· OAuth æˆæƒ |
|              | `oauth.callback`  | OAuth å›è°ƒå¤„ç†  |
| **Discord**  | `invite.generate` | ç”Ÿæˆé‚€è¯·é“¾æ¥    |

> **æ³¨æ„**: å¹³å° Action ç”±å„ Plugin å†…éƒ¨å¤„ç†ï¼Œä¸ç»è¿‡ Gateway ActionHandler

### 6.5 å¯¹è¯ Action åˆ—è¡¨

| åˆ†ç±»         | Action            | è¯´æ˜           | è·¯ç”±åˆ°         |
| ------------ | ----------------- | -------------- | -------------- |
| **å‘é€æ¶ˆæ¯** | `chat.send`       | ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯ | å½“å‰ä¼šè¯ Agent |
| **æ¶ˆæ¯æ“ä½œ** | `chat.regenerate` | é‡æ–°ç”Ÿæˆå›ç­”   | å½“å‰ä¼šè¯ Agent |
|              | `chat.continue`   | ç»§ç»­ç”Ÿæˆ       | å½“å‰ä¼šè¯ Agent |
|              | `chat.stop`       | åœæ­¢ç”Ÿæˆ       | å½“å‰ä¼šè¯ Agent |

### 6.6 Action æ•°æ®ç»“æ„

```
UnifiedAction {
  action: string          // Action ç±»å‹
  params?: object         // å¯é€‰å‚æ•°
  context: {
    platform: string      // æ¥æºå¹³å°
    userId: string        // ç”¨æˆ· ID
    chatId: string        // èŠå¤© ID
    messageId?: string    // è§¦å‘æ¶ˆæ¯ ID
    sessionId?: string    // å½“å‰ä¼šè¯ ID
  }
}
```

### 6.7 æŒ‰é’®å›è°ƒæ•°æ®æ ¼å¼

```
æ ¼å¼: action:param1=value1,param2=value2

ç¤ºä¾‹:
â€¢ "session.new"
â€¢ "settings.model.select:id=gemini-pro"
â€¢ "chat.regenerate:msg=abc123"
```

### 6.8 ç»Ÿä¸€å“åº”æ ¼å¼

```
ActionResponse {
  text?: string                    // æ–‡æœ¬å†…å®¹
  parseMode?: 'plain' | 'markdown' // è§£ææ¨¡å¼
  buttons?: ActionButton[][]       // Inline æŒ‰é’®
  keyboard?: ActionButton[][]      // Reply Keyboard
  behavior: 'send' | 'edit' | 'answer'  // å“åº”è¡Œä¸º
  toast?: string                   // Toast æç¤º
}
```

---

## 7. ä¼šè¯ç®¡ç†

### 7.1 ä¼šè¯ä¸ Agent å…³ç³»

```
Session {
  id: string              // ä¼šè¯ ID
  platform: string        // æ¥æºå¹³å°
  userId: string          // ç”¨æˆ· ID
  chatId: string          // èŠå¤© ID

  // Agent é…ç½®
  agentType: string       // gemini / acp / codex
  agentConfig: {
    modelId?: string      // æ¨¡å‹ ID
  }

  // ä¼šè¯çŠ¶æ€
  status: string          // active / idle / error
  context: object         // Agent ä¼šè¯ä¸Šä¸‹æ–‡

  // å…ƒæ•°æ®
  createdAt: number
  lastActiveAt: number
}
```

### 7.2 MVP é˜¶æ®µä¼šè¯ç­–ç•¥

| é¡¹ç›®     | MVP å®ç°               |
| -------- | ---------------------- |
| ä¼šè¯æ¨¡å¼ | å•æ´»è·ƒä¼šè¯             |
| æ–°å»ºä¼šè¯ | ç‚¹å‡» ğŸ†• æŒ‰é’®æ¸…ç©ºä¸Šä¸‹æ–‡ |
| ä¼šè¯å­˜å‚¨ | ç‹¬ç«‹äº AionUi GUI ä¼šè¯ |
| Agent    | å›ºå®š Gemini            |
| Model    | ä½¿ç”¨ AionUi é»˜è®¤é…ç½®   |

### 7.3 åæœŸæ‰©å±•

| é¡¹ç›®       | æ‰©å±•å†…å®¹                               |
| ---------- | -------------------------------------- |
| å¤šä¼šè¯     | æ”¯æŒ `session.list` / `session.switch` |
| Agent åˆ‡æ¢ | æ”¯æŒ `settings.agent.select`           |
| Model åˆ‡æ¢ | æ”¯æŒåŠ¨æ€é€‰æ‹©æ¨¡å‹                       |
| ä¼šè¯åŒæ­¥   | Telegram ä¼šè¯ä¸ AionUi ä¼šè¯å…³è”        |

---

## 8. æ¶ˆæ¯æµå¼å¤„ç†æ¶æ„

### 8.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Worker (Gemini/ACP/Codex)              â”‚
â”‚                    (Agent Worker è¿›ç¨‹)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‘é€æ¶ˆæ¯äº‹ä»¶åˆ° IPC Bridge                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ChannelEventBus                               â”‚
â”‚                    (å…¨å±€äº‹ä»¶æ€»çº¿ - å•ä¾‹)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  emitAgentMessage(conversationId, data)                          â”‚
â”‚  onAgentMessage(handler) â†’ () => void (cleanup)                  â”‚
â”‚                                                                  â”‚
â”‚  äº‹ä»¶ç±»å‹: 'channel.agent.message'                               â”‚
â”‚  æ•°æ®ç»“æ„: IAgentMessageEvent { ...IResponseMessage, conv_id }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ChannelMessageService                         â”‚
â”‚                    (æ¶ˆæ¯æœåŠ¡ - å•ä¾‹)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  initialize() {                                                  â”‚
â”‚    // æœåŠ¡åˆå§‹åŒ–æ—¶æ³¨å†Œå…¨å±€äº‹ä»¶ç›‘å¬                               â”‚
â”‚    channelEventBus.onAgentMessage(this.handleAgentMessage);    â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  handleAgentMessage(event) {                                     â”‚
â”‚    // å¤„ç†ç‰¹æ®Šäº‹ä»¶: start, finish, error                         â”‚
â”‚    // ä½¿ç”¨ transformMessage + composeMessage åˆå¹¶æ¶ˆæ¯            â”‚
â”‚    // å›è°ƒé€šçŸ¥: callback(TMessage, isInsert)                     â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  sendMessage(sessionId, conversationId, text, callback) {        â”‚
â”‚    // ä»…å‘é€æ¶ˆæ¯ï¼Œä¸å¤„ç†ç›‘å¬                                     â”‚
â”‚    // é€šè¿‡ WorkerManage è°ƒç”¨ Agent Task                          â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  å†…éƒ¨çŠ¶æ€:                                                       â”‚
â”‚    activeStreams: Map<conversationId, IStreamState>              â”‚
â”‚    messageListMap: Map<conversationId, TMessage[]>               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ActionExecutor                                â”‚
â”‚                    (ä¸šåŠ¡æ‰§è¡Œå™¨)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  handleChatMessage(context, text) {                              â”‚
â”‚    messageService.sendMessage(                                   â”‚
â”‚      sessionId, conversationId, text,                             â”‚
â”‚      (message: TMessage, isInsert: boolean) => {                 â”‚
â”‚        const outgoing = convertTMessageToOutgoing(message, platform); â”‚
â”‚        if (isInsert) context.sendMessage(outgoing);              â”‚
â”‚        else context.editMessage(msgId, outgoing);                â”‚
â”‚      }                                                           â”‚
â”‚    );                                                            â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  convertTMessageToOutgoing(message, platform) {                  â”‚
â”‚    // TMessage â†’ IUnifiedOutgoingMessage                         â”‚
â”‚    // æ ¹æ®å¹³å°æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆHTML/Markdownï¼‰                        â”‚
â”‚    // text â†’ æ˜¾ç¤ºå†…å®¹                                            â”‚
â”‚    // tips â†’ å¸¦å›¾æ ‡æç¤º                                          â”‚
â”‚    // tool_group â†’ å·¥å…·çŠ¶æ€åˆ—è¡¨                                  â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Plugin (Telegram/Lark)                       â”‚
â”‚                    (å¹³å°æ’ä»¶)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sendMessage(chatId, message: IUnifiedOutgoingMessage)           â”‚
â”‚  editMessage(chatId, messageId, message: IUnifiedOutgoingMessage)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 äº‹ä»¶ç±»å‹å¤„ç†

| äº‹ä»¶ç±»å‹            | æ¥æº           | å¤„ç†æ–¹å¼                                     |
| ------------------- | -------------- | -------------------------------------------- |
| `start`             | Agent å¼€å§‹å“åº” | é‡ç½®æ¶ˆæ¯åˆ—è¡¨                                 |
| `content`           | æµå¼æ–‡æœ¬å—     | transformMessage â†’ composeMessage â†’ callback |
| `tool_group`        | å·¥å…·è°ƒç”¨çŠ¶æ€   | åˆå¹¶åˆ°ç°æœ‰ tool_group æˆ–æ–°å¢                 |
| `finish`/`finished` | å“åº”å®Œæˆ       | resolve promiseï¼Œæ¸…ç†çŠ¶æ€                    |
| `error`             | å‘ç”Ÿé”™è¯¯       | reject promiseï¼Œæ¸…ç†çŠ¶æ€                     |
| `thought`           | æ€è€ƒè¿‡ç¨‹       | å¿½ç•¥ï¼ˆtransformMessage è¿”å› undefinedï¼‰      |

### 8.3 æ¶ˆæ¯åˆå¹¶ç­–ç•¥ (composeMessage)

| æ¶ˆæ¯ç±»å‹     | åˆå¹¶è§„åˆ™                             |
| ------------ | ------------------------------------ |
| `text`       | åŒ msg_id ç´¯åŠ å†…å®¹ï¼Œä¸åŒ msg_id æ–°å¢ |
| `tool_group` | æŒ‰ callId åˆå¹¶å·¥å…·çŠ¶æ€æ›´æ–°           |
| `tool_call`  | æŒ‰ callId åˆå¹¶                       |
| `tips`       | ç›´æ¥æ–°å¢                             |

### 8.4 æ¶ˆæ¯å›è°ƒå‚æ•°

```typescript
type StreamCallback = (chunk: TMessage, isInsert: boolean) => void;

// isInsert = true:  æ–°æ¶ˆæ¯ï¼Œè°ƒç”¨ sendMessage å‘é€æ–°æ¶ˆæ¯
// isInsert = false: æ›´æ–°æ¶ˆæ¯ï¼Œè°ƒç”¨ editMessage ç¼–è¾‘ç°æœ‰æ¶ˆæ¯
```

### 8.5 èŠ‚æµæ§åˆ¶

| å‚æ•°               | å€¼     | è¯´æ˜                      |
| ------------------ | ------ | ------------------------- |
| UPDATE_THROTTLE_MS | 500ms  | æ¶ˆæ¯ç¼–è¾‘æœ€å°é—´éš”          |
| å‘é€æ–°æ¶ˆæ¯         | æ— é™åˆ¶ | isInsert=true æ—¶ç«‹å³å‘é€  |
| ç¼–è¾‘æ¶ˆæ¯           | èŠ‚æµ   | isInsert=false æ—¶åº”ç”¨èŠ‚æµ |

- [ ] ä½¿ç”¨ç°æœ‰ Context: **\*\*\*\***\_\_\_\_**\*\*\*\***
- [ ] éœ€è¦æ–°å¢ Context: **\*\*\*\***\_\_\_\_**\*\*\*\***
- [ ] ä»…ç»„ä»¶å†…éƒ¨çŠ¶æ€ (useState/useReducer)
- [ ] éœ€è¦æŒä¹…åŒ–å­˜å‚¨

### 8.6 å…³é”®è®¾è®¡åŸåˆ™

1. **äº‹ä»¶ç›‘å¬ä¸æ¶ˆæ¯å‘é€åˆ†ç¦»**
   - äº‹ä»¶ç›‘å¬åœ¨æœåŠ¡åˆå§‹åŒ–æ—¶å®Œæˆï¼ˆ`initialize()`ï¼‰
   - `sendMessage()` ä»…è´Ÿè´£å‘é€æ¶ˆæ¯ï¼Œä¸å¤„ç†ç›‘å¬

2. **å…¨å±€äº‹ä»¶æ€»çº¿è§£è€¦**
   - `ChannelMessageService` ä¸ç›´æ¥ä¸ Agent Task äº¤äº’
   - é€šè¿‡ `ChannelEventBus` å…¨å±€äº‹ä»¶æ€»çº¿è§£è€¦

3. **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼**
   - å†…éƒ¨ä½¿ç”¨ `TMessage` ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
   - è¾“å‡ºæ—¶è½¬æ¢ä¸º `IUnifiedOutgoingMessage`

---

## 9. Agent æ¥å£è§„èŒƒ

### 8.1 æ¯ä¸ª Agent éœ€å®ç°çš„èƒ½åŠ›

| èƒ½åŠ›            | è¯´æ˜               |
| --------------- | ------------------ |
| `sendMessage`   | å‘é€æ¶ˆæ¯å¹¶è·å–å“åº” |
| `streamMessage` | æµå¼å‘é€æ¶ˆæ¯       |
| `regenerate`    | é‡æ–°ç”Ÿæˆä¸Šä¸€æ¡å›å¤ |
| `continue`      | ç»§ç»­ç”Ÿæˆ           |
| `stop`          | åœæ­¢å½“å‰ç”Ÿæˆ       |
| `getContext`    | è·å–ä¼šè¯ä¸Šä¸‹æ–‡     |
| `clearContext`  | æ¸…ç©ºä¼šè¯ä¸Šä¸‹æ–‡     |

### 8.2 Agent å“åº”æ ¼å¼

```
AgentResponse {
  type: 'text' | 'stream_start' | 'stream_chunk' | 'stream_end' | 'error'
  text?: string
  chunk?: string
  error?: { code: string, message: string }
  metadata?: {
    model?: string
    tokensUsed?: number
    duration?: number
  }
  suggestedActions?: ActionButton[]
}
```

---

## 9. æ–‡ä»¶ç»“æ„ï¼ˆå®é™…å®ç°ï¼‰

```
src/channels/
â”œâ”€â”€ core/                          # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ ChannelManager.ts          # ç»Ÿä¸€ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
â”‚   â””â”€â”€ SessionManager.ts          # ä¼šè¯ç®¡ç†
â”‚
â”œâ”€â”€ gateway/                       # ç½‘å…³å±‚
â”‚   â”œâ”€â”€ PluginManager.ts           # æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â””â”€â”€ ActionExecutor.ts          # Action æ‰§è¡Œå™¨ï¼ˆè·¯ç”±ã€æ¶ˆæ¯å¤„ç†ï¼‰
â”‚
â”œâ”€â”€ actions/                       # Action å¤„ç†ï¼ˆå¹³å°æ— å…³ï¼‰
â”‚   â”œâ”€â”€ types.ts                   # Action/Response ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ SystemActions.ts          # ç³»ç»Ÿ Actionï¼ˆä¼šè¯ã€è®¾ç½®ã€å¸®åŠ©ï¼‰
â”‚   â”œâ”€â”€ ChatActions.ts            # å¯¹è¯ Actionï¼ˆå‘é€ã€é‡æ–°ç”Ÿæˆç­‰ï¼‰
â”‚   â””â”€â”€ PlatformActions.ts        # å¹³å° Actionï¼ˆé…å¯¹ç­‰ï¼‰
â”‚
â”œâ”€â”€ agent/                         # Agent é›†æˆ
â”‚   â”œâ”€â”€ ChannelEventBus.ts        # å…¨å±€äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ ChannelMessageService.ts  # æ¶ˆæ¯æµå¼å¤„ç†æœåŠ¡
â”‚
â”œâ”€â”€ pairing/                       # é…å¯¹æœåŠ¡
â”‚   â””â”€â”€ PairingService.ts         # é…å¯¹ç ç”Ÿæˆå’ŒéªŒè¯ï¼ˆå¹³å°æ— å…³ï¼‰
â”‚
â”œâ”€â”€ plugins/                       # æ’ä»¶ç›®å½•
â”‚   â”œâ”€â”€ BasePlugin.ts              # æ’ä»¶æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ TelegramPlugin.ts      # Telegram æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ TelegramAdapter.ts     # æ¶ˆæ¯é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ TelegramKeyboards.ts   # é”®ç›˜ç»„ä»¶
â”‚   â””â”€â”€ lark/
â”‚       â”œâ”€â”€ LarkPlugin.ts          # Lark æ’ä»¶
â”‚       â”œâ”€â”€ LarkAdapter.ts         # æ¶ˆæ¯é€‚é…å™¨
â”‚       â””â”€â”€ LarkCards.ts           # Card ç»„ä»¶
â”‚
â”œâ”€â”€ utils/                         # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ credentialCrypto.ts        # å‡­è¯åŠ å¯†
â”‚
â””â”€â”€ types.ts                       # ç±»å‹å®šä¹‰
```

---

## 10. æ•°æ®åº“è®¾è®¡

| è¡¨å                      | ç”¨é€”                      |
| ------------------------- | ------------------------- |
| `assistant_plugins`       | æ’ä»¶é…ç½®ï¼ˆTokenã€æ¨¡å¼ç­‰ï¼‰ |
| `assistant_users`         | å·²æˆæƒç”¨æˆ·åˆ—è¡¨            |
| `assistant_sessions`      | ç”¨æˆ·ä¼šè¯å…³è”              |
| `assistant_pairing_codes` | å¾…æ‰¹å‡†çš„é…å¯¹è¯·æ±‚          |

---

## 11. å¤–éƒ¨ä¾èµ–

| ä¾èµ–åŒ…                    | ç”¨é€”                  | è¯´æ˜                    |
| ------------------------- | --------------------- | ----------------------- |
| `grammy`                  | Telegram Bot          | Clawdbot ä½¿ç”¨ï¼ŒAPI ä¼˜é›… |
| `@larksuiteoapi/node-sdk` | Lark/Feishu Bot       | å®˜æ–¹ SDK                |
| `@slack/bolt`             | Slack Botï¼ˆå¾…å®ç°ï¼‰   | å®˜æ–¹ SDK                |
| `discord.js`              | Discord Botï¼ˆå¾…å®ç°ï¼‰ | å®˜æ–¹ SDK                |

---

## 12. å®ç°çŠ¶æ€

### 12.1 å·²å®ç°åŠŸèƒ½

#### Telegram

- [x] Bot Token é…ç½®å’ŒéªŒè¯
- [x] Bot å¯åŠ¨/åœæ­¢æ§åˆ¶ï¼ˆPolling æ¨¡å¼ï¼Œè‡ªåŠ¨é‡è¿ï¼‰
- [x] é…å¯¹ç ç”Ÿæˆå’Œæœ¬åœ°æ‰¹å‡†æµç¨‹
- [x] å·²æˆæƒç”¨æˆ·ç®¡ç†
- [x] æŒ‰é’®äº¤äº’ï¼ˆReply Keyboard + Inline Keyboardï¼‰
- [x] ä¸ Gemini/ACP/Codex Agent å¯¹è¯
- [x] æ–°å»ºä¼šè¯åŠŸèƒ½
- [x] æµå¼æ¶ˆæ¯å“åº”ï¼ˆeditMessage æ›´æ–°ï¼‰
- [x] å·¥å…·ç¡®è®¤äº¤äº’
- [x] é”™è¯¯æ¢å¤æœºåˆ¶

#### Lark/Feishu

- [x] App ID/Secret é…ç½®å’ŒéªŒè¯
- [x] Bot å¯åŠ¨/åœæ­¢æ§åˆ¶ï¼ˆWebSocket é•¿è¿æ¥ï¼‰
- [x] é…å¯¹ç ç”Ÿæˆå’Œæœ¬åœ°æ‰¹å‡†æµç¨‹
- [x] å·²æˆæƒç”¨æˆ·ç®¡ç†
- [x] Card äº¤äº’ï¼ˆæŒ‰é’®ã€ç¡®è®¤ç­‰ï¼‰
- [x] ä¸ Gemini/ACP/Codex Agent å¯¹è¯
- [x] æ–°å»ºä¼šè¯åŠŸèƒ½
- [x] æµå¼æ¶ˆæ¯å“åº”ï¼ˆupdateMessage æ›´æ–°ï¼‰
- [x] å·¥å…·ç¡®è®¤äº¤äº’ï¼ˆCard æ ¼å¼ï¼‰
- [x] äº‹ä»¶å»é‡æœºåˆ¶ï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰
- [x] HTML è½¬ Lark Markdown

#### æ ¸å¿ƒåŠŸèƒ½

- [x] ChannelManager ç»Ÿä¸€ç®¡ç†
- [x] PluginManager æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [x] SessionManager ä¼šè¯ç®¡ç†
- [x] PairingService é…å¯¹æœåŠ¡
- [x] ActionExecutor Action è·¯ç”±å’Œæ‰§è¡Œ
- [x] ChannelMessageService æ¶ˆæ¯æµå¼å¤„ç†
- [x] ChannelEventBus å…¨å±€äº‹ä»¶æ€»çº¿
- [x] å‡­è¯åŠ å¯†å­˜å‚¨
- [x] å¤šå¹³å°ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼

### 12.2 å®‰å…¨éªŒæ”¶

- [x] é…å¯¹ç  10 åˆ†é’Ÿè¿‡æœŸ
- [x] å¿…é¡»åœ¨ AionUi æœ¬åœ°æ‰¹å‡†
- [x] æœªæˆæƒç”¨æˆ·æ— æ³•ä½¿ç”¨
- [x] Token/å‡­è¯åŠ å¯†å­˜å‚¨
- [ ] é€Ÿç‡é™åˆ¶ï¼ˆå¾…å®ç°ï¼‰

### 12.3 å…¼å®¹æ€§

- [x] macOS æ­£å¸¸è¿è¡Œ
- [x] Windows æ­£å¸¸è¿è¡Œ
- [x] å¤šè¯­è¨€æ”¯æŒï¼ˆi18nï¼‰

---

## 13. åæœŸæ‰©å±•è·¯çº¿

| é˜¶æ®µ        | å†…å®¹                        | çŠ¶æ€        |
| ----------- | --------------------------- | ----------- |
| **Phase 1** | Telegram + Lark æ¥å…¥        | âœ… å·²å®Œæˆ   |
| **Phase 2** | å¤šä¼šè¯ç®¡ç†ã€ä¼šè¯åˆ‡æ¢        | ğŸ”„ å¾…å®ç°   |
| **Phase 3** | Agent åˆ‡æ¢ï¼ˆå·²æ”¯æŒï¼Œéœ€ UIï¼‰ | ğŸ”„ éƒ¨åˆ†å®Œæˆ |
| **Phase 4** | Model åŠ¨æ€åˆ‡æ¢              | ğŸ”„ å¾…å®ç°   |
| **Phase 5** | Slack å¹³å°æ¥å…¥              | ğŸ”„ å¾…å®ç°   |
| **Phase 6** | Discord å¹³å°æ¥å…¥            | ğŸ”„ å¾…å®ç°   |
| **Phase 7** | é€Ÿç‡é™åˆ¶                    | ğŸ”„ å¾…å®ç°   |
| **Phase 8** | ä¼šè¯ä¸ AionUi åŒæ­¥          | ğŸ”„ å¾…å®ç°   |
| **Phase 9** | Headless ç‹¬ç«‹æœåŠ¡æ¨¡å¼       | ğŸ”„ å¾…å®ç°   |

---

## æ¨¡æ¿ç»´æŠ¤

- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **æœ€åæ›´æ–°**: 2026-02-03
- **é€‚ç”¨ç‰ˆæœ¬**: AionUi v1.7.8+
- **ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ

---

## é™„å½•ï¼šå…³é”®å®ç°ç»†èŠ‚

### A.1 ChannelManager åˆå§‹åŒ–æµç¨‹

```typescript
1. ChannelManager.getInstance().initialize()
   â”œâ”€ åˆå§‹åŒ– PluginManager
   â”œâ”€ åˆå§‹åŒ– SessionManager
   â”œâ”€ åˆå§‹åŒ– PairingService
   â”œâ”€ åˆå§‹åŒ– ActionExecutor
   â””â”€ åˆå§‹åŒ– ChannelMessageService

2. åŠ è½½æ•°æ®åº“ä¸­çš„æ’ä»¶é…ç½®
3. ä¸ºæ¯ä¸ªå¯ç”¨çš„æ’ä»¶è°ƒç”¨ initialize() å’Œ start()
```

### A.2 æ¶ˆæ¯å¤„ç†æµç¨‹

```typescript
1. Plugin æ¥æ”¶å¹³å°æ¶ˆæ¯
   â””â”€ toUnifiedIncomingMessage() è½¬æ¢

2. PluginManager è°ƒç”¨ messageHandler
   â””â”€ ActionExecutor.handleMessage()

3. ActionExecutor è·¯ç”± Action
   â”œâ”€ Platform Action â†’ PlatformActions
   â”œâ”€ System Action â†’ SystemActions
   â””â”€ Chat Action â†’ ChannelMessageService

4. ChannelMessageService.sendMessage()
   â””â”€ é€šè¿‡ WorkerManage è°ƒç”¨ Agent Task

5. Agent å“åº” â†’ ChannelEventBus
   â””â”€ ChannelMessageService.handleAgentMessage()
      â””â”€ StreamCallback â†’ ActionExecutor
         â””â”€ Plugin.sendMessage/editMessage()
```

### A.3 å¹³å°ç‰¹å®šå®ç°

**Telegram**

- ä½¿ç”¨ grammY åº“
- Polling æ¨¡å¼ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿
- Inline Keyboard + Reply Keyboard
- HTML æ ¼å¼æ¶ˆæ¯

**Lark/Feishu**

- ä½¿ç”¨å®˜æ–¹ Node SDK
- WebSocket é•¿è¿æ¥æ¨¡å¼
- Card æ ¼å¼äº¤äº’
- Lark Markdown æ ¼å¼æ¶ˆæ¯
- äº‹ä»¶å»é‡æœºåˆ¶ï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰
