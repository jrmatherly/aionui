# =============================================================================
# AionUI Docker Compose Configuration
# Orchestrates AionUI WebUI server with persistent storage
# =============================================================================
#
# Usage (from project root):
#   docker-compose -f deploy/docker/docker-compose.yml up -d
#   docker-compose -f deploy/docker/docker-compose.yml logs -f
#   docker-compose -f deploy/docker/docker-compose.yml down
#   docker-compose -f deploy/docker/docker-compose.yml up -d --build
#
# Or from deploy/docker directory:
#   cd deploy/docker && docker-compose up -d
#
# Access:
#   http://localhost:25808            # Local access
#   http://<host-ip>:25808            # Network access
#
# =============================================================================

services:
  aionui:
    image: aionui:latest
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        # Tool versions: should match mise.lock for reproducibility.
        # Override with: NODE_VERSION=24.13.0 docker-compose ... build
        # Or use: mise run docker:build (auto-reads from mise.lock)
        NODE_VERSION: ${NODE_VERSION:-24.13.0}
        NPM_VERSION: ${NPM_VERSION:-11.9.0}
        TARGETARCH: ${TARGETARCH:-arm64}
        # Note: All CLI tools are now baked into the image by default.
        # Use DISABLE_CLI_* env vars at runtime to hide specific tools.
    container_name: aionui
    restart: unless-stopped

    # Port mapping
    ports:
      - '${AIONUI_PORT:-25808}:25808'

    # Environment configuration
    # Copy .env.example to .env and customize, or set variables here
    env_file:
      - path: .env
        required: false
    environment:
      # Override defaults from .env if needed
      - AIONUI_PORT=${AIONUI_PORT:-25808}
      - AIONUI_ALLOW_REMOTE=${AIONUI_ALLOW_REMOTE:-true}
      - NODE_ENV=${NODE_ENV:-production}
      - DISPLAY_NUM=${DISPLAY_NUM:-99}
      - SCREEN_RESOLUTION=${SCREEN_RESOLUTION:-1024x768x24}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-}
      - LOG_FORMAT=${LOG_FORMAT:-}
      - LOG_FILE=${LOG_FILE:-}
      # OpenTelemetry (OTEL)
      - OTEL_ENABLED=${OTEL_ENABLED:-false}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL:-http}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-aionui}
      - OTEL_LOG_LEVEL=${OTEL_LOG_LEVEL:-}
      # Log file rotation
      - LOG_MAX_SIZE_MB=${LOG_MAX_SIZE_MB:-}
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-}
      # Syslog / SIEM
      - SYSLOG_ENABLED=${SYSLOG_ENABLED:-false}
      - SYSLOG_HOST=${SYSLOG_HOST:-}
      - SYSLOG_PORT=${SYSLOG_PORT:-514}
      - SYSLOG_PROTOCOL=${SYSLOG_PROTOCOL:-udp}
      - SYSLOG_FACILITY=${SYSLOG_FACILITY:-16}
      # Langfuse - LLM Observability
      - LANGFUSE_ENABLED=${LANGFUSE_ENABLED:-false}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      # GLOBAL_MODELS_JSON and GLOBAL_MODELS_FILE are passed through via env_file
      # Do NOT override here — JSON values break docker-compose variable interpolation
      # Security (set in .env for production)
      - JWT_SECRET=${JWT_SECRET}
      - AIONUI_ADMIN_PASSWORD=${AIONUI_ADMIN_PASSWORD:-}
      # - AIONUI_HTTPS=${AIONUI_HTTPS:-false}
      # OIDC / EntraID SSO (optional)
      - OIDC_ENABLED=${OIDC_ENABLED:-false}
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-}
      - OIDC_SCOPES=${OIDC_SCOPES:-openid profile email}
      - OIDC_GROUPS_CLAIM=${OIDC_GROUPS_CLAIM:-groups}
      # GROUP_MAPPINGS_JSON and GROUP_MAPPINGS_FILE are passed through via env_file
      # Do NOT override here — JSON values break docker-compose variable interpolation
      # Feature flags
      - ALLOW_CLAUDE_YOLO=${ALLOW_CLAUDE_YOLO:-false}
      - ALLOW_GEMINI_YOLO=${ALLOW_GEMINI_YOLO:-false}
      # Branding (optional, for custom forks)
      - AIONUI_BRAND_NAME=${AIONUI_BRAND_NAME:-}
      - AIONUI_GITHUB_REPO=${AIONUI_GITHUB_REPO:-}
      - AIONUI_WEBSITE_URL=${AIONUI_WEBSITE_URL:-}
      - AIONUI_CONTACT_URL=${AIONUI_CONTACT_URL:-}
      - AIONUI_FEEDBACK_URL=${AIONUI_FEEDBACK_URL:-}
      # Multi-Agent CLI API Keys (optional, for env-based auth)
      # Per-user keys via UI take precedence; these are container-level fallbacks.
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}

    # Persistent storage
    volumes:
      # Database, config, and session data
      - aionui_data:/home/aionui/.config/AionUi
      # Per-user workspaces (Python venvs, skills, assistants)
      - user_workspaces:/data/users
      # mise cache (shared Python/uv installs, avoid re-downloading)
      - mise_cache:/mise/cache
      # OIDC group→role mappings (file-based, see GROUP_MAPPINGS_FILE in .env)
      - ./group-mappings.json:/etc/aionui/group-mappings.json:ro
      # Global models config (file-based, see GLOBAL_MODELS_FILE in .env)
      - ./global-models.json:/etc/aionui/global-models.json:ro
      # Optional: Mount custom skills (read-only)
      # - ./custom-skills:/app/resources/skills:ro
      # Optional: Mount CLI auth/config for OAuth-based CLIs (multi-agent mode)
      # - ${HOME}/.claude:/home/aionui/.claude:ro
      # - ${HOME}/.copilot:/home/aionui/.copilot:ro
      # - ${HOME}/.auggie:/home/aionui/.auggie:ro

    # Shared memory for Chromium (prevents crashes)
    shm_size: '2gb'

    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://localhost:25808/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G
          cpus: '0.5'

    # Logging configuration
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

    # Security options
    security_opt:
      - no-new-privileges:true

# Named volumes for data persistence
volumes:
  aionui_data:
    driver: local
  # Per-user workspaces (Python venvs, skills, assistants)
  user_workspaces:
    driver: local
  # mise cache (shared Python/uv installs across container restarts)
  mise_cache:
    driver: local

# =============================================================================
# Production Notes:
#
# 1. Set JWT_SECRET environment variable for consistent auth tokens
#
# 2. For HTTPS, deploy behind a reverse proxy (nginx/Traefik):
#    - Configure SSL termination at the proxy
#    - Set AIONUI_HTTPS=true
#
# 3. For multi-instance deployment, ensure unique JWT_SECRET per instance
#    or use a shared secret for session portability
#
# 4. Backup the aionui_data volume regularly:
#    docker run --rm -v aionui_data:/data -v $(pwd):/backup \
#      alpine tar czf /backup/aionui-backup.tar.gz -C /data .
#
# =============================================================================
