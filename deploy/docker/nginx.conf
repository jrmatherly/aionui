# =============================================================================
# AionUI — nginx reverse proxy with SSL termination
# =============================================================================
#
# Usage:
#   1. Place your SSL cert and key at the paths specified below
#      (or update ssl_certificate / ssl_certificate_key paths)
#   2. Replace 'your-domain.example.com' with your actual hostname
#   3. Use with docker-compose.https.yml:
#      docker compose -f docker-compose.yml -f docker-compose.https.yml up -d
#
# For Let's Encrypt / ACME:
#   - Mount /etc/letsencrypt into the nginx container
#   - Use certbot with --webroot or DNS challenge
#   - Set ssl_certificate to /etc/letsencrypt/live/<domain>/fullchain.pem
#   - Set ssl_certificate_key to /etc/letsencrypt/live/<domain>/privkey.pem
#
# =============================================================================

# Upstream for the AionUI application (HTTP only, no TLS)
upstream aionui_backend {
    server aionui:25808;
}

# Redirect all HTTP traffic to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.example.com;

    # Allow ACME challenge for Let's Encrypt cert renewal
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server — SSL termination + reverse proxy
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name your-domain.example.com;

    # --- SSL Configuration ---
    ssl_certificate     /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # Modern TLS configuration (TLS 1.2+ only)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # OCSP stapling for faster TLS handshakes
    ssl_stapling on;
    ssl_stapling_verify on;

    # SSL session caching
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # --- Security Headers ---
    # Note: AionUI sets its own security headers (CSP, HSTS, X-Frame-Options, etc.)
    # via AuthMiddleware.securityHeadersMiddleware. Avoid duplicating them here
    # to prevent double-header issues. Only add headers nginx needs to set.

    # --- Proxy Settings ---
    # Max upload size (must match or exceed Express body parser limit)
    client_max_body_size 100M;

    # Proxy timeouts (generous for long-running AI agent responses)
    proxy_connect_timeout 60s;
    proxy_send_timeout    300s;
    proxy_read_timeout    300s;

    # --- Locations ---

    # WebSocket endpoint — required for real-time streaming
    # AionUI uses WebSocket on the same port as HTTP (upgrade on any path)
    location / {
        proxy_pass http://aionui_backend;

        # Standard proxy headers
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Forwarded-Port  $server_port;

        # WebSocket upgrade support
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Disable response buffering for streaming (SSE / WebSocket)
        proxy_buffering off;
        proxy_cache off;
    }
}

# Required for WebSocket upgrade detection
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
