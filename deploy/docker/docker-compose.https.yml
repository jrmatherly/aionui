# =============================================================================
# AionUI — HTTPS overlay (use with base docker-compose.yml)
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.https.yml up -d
#
# Prerequisites:
#   1. SSL certificate and key in ./ssl/ directory:
#      ./ssl/fullchain.pem  (certificate + intermediate chain)
#      ./ssl/privkey.pem    (private key)
#
#   2. Update nginx.conf with your actual domain name
#
#   3. Set in .env:
#      AIONUI_HTTPS=true
#      AIONUI_TRUST_PROXY=1
#      OIDC_REDIRECT_URI=https://your-domain.example.com/api/auth/oidc/callback
#
# For Let's Encrypt:
#   mkdir -p ./ssl ./certbot
#   # Initial cert (standalone mode — stop nginx first):
#   docker run --rm -p 80:80 -v ./ssl:/etc/letsencrypt/live/your-domain \
#     -v ./certbot:/var/www/certbot certbot/certbot certonly \
#     --standalone -d your-domain.example.com
#
#   # Renewal (webroot mode — nginx running):
#   docker run --rm -v ./ssl:/etc/letsencrypt -v ./certbot:/var/www/certbot \
#     certbot/certbot renew --webroot -w /var/www/certbot
#
# =============================================================================

services:
  # Override AionUI to enable HTTPS-aware settings and remove direct port exposure
  aionui:
    environment:
      - AIONUI_HTTPS=${AIONUI_HTTPS:-true}
      - AIONUI_TRUST_PROXY=${AIONUI_TRUST_PROXY:-1}
    # Remove host port binding — nginx handles all external traffic.
    # The container port (25808) remains accessible to nginx via the Docker network.
    # !override replaces the base ports list entirely (Compose v2.24+).
    ports: !override []

  # nginx reverse proxy with SSL termination
  nginx:
    image: nginx:alpine
    container_name: aionui-nginx
    restart: unless-stopped
    ports:
      - "${HTTPS_PORT:-443}:443"
      - "${HTTP_PORT:-80}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./certbot:/var/www/certbot:ro
    depends_on:
      aionui:
        condition: service_healthy
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
